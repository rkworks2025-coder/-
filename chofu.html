<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>調布市 巡回</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="appbar">
    <a href="index.html" class="backlink">← 戻る</a>
    <div class="title">調布市 巡回</div>
    <span id="counter" class="counter"></span>
  </header>
  <div class="wrap">
    <section id="list" class="list"></section>
    <p id="empty" class="empty">まだ同期されていません</p>
  </div>
  
  
  <script>
    (function(){ 
      const CITY_CANON = '調布市'; // 例: 大和市, 海老名市, 調布市
      const $ = (s,r=document)=>r.querySelector(s);
      const KEYS = ['junkai:items','junkai:items:v2']; // indexは 'junkai:items' を使用

      function load(){ 
        for (const k of KEYS){
          try{ const s=localStorage.getItem(k); if(s){ const a=JSON.parse(s); if(Array.isArray(a)) return a; } }catch(_){}
        }
        return [];
      }
      function canonCity(s){
        if(!s) return '';
        return String(s).replace(/巡回/g,'').replace(/\s+/g,'').trim();
      }
      function migrate(items){
        let changed=false;
        items.forEach(it=>{
          if (typeof it.done==='undefined' || typeof it.state==='undefined') {
            const st = it.status||'';
            it.done = (st==='済') ? 1 : 0;
            it.state = (st==='停') ? 'stopped' : (st==='不要' ? 'skip' : 'normal');
            changed=true;
          }
          it.status = it.done ? '済' : (it.state==='stopped' ? '停' : (it.state==='skip' ? '不要' : ''));
        });
        if (changed){ try{ localStorage.setItem('junkai:items', JSON.stringify(items)); }catch(__){} }
        return items;
      }
      function fmt(ts){ if(!ts) return ''; const d=new Date(ts); const M=String(d.getMonth()+1).padStart(2,'0'); const D=String(d.getDate()).padStart(2,'0'); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${M}/${D} ${h}:${m}`; }
      function updateCounter(done,total){ const el=$('#counter'); const pct= total? Math.floor(done*100/total):0; if(el) el.textContent = `${done}/${total} (${pct}%)`; }
      function applyClass(el, it){ el.classList.remove('stop','skip','done'); if(it.state==='stopped') el.classList.add('stop'); else if(it.state==='skip') el.classList.add('skip'); if(it.done) el.classList.add('done'); }

      function applyClass(el,it){ el.classList.remove('stop','skip','done'); if(it.state==='stopped') el.classList.add('stop'); else if(it.state==='skip') el.classList.add('skip'); if(it.done) el.classList.add('done'); }
function applyVisual(el,it){ const pink='#ffd1e1', gray='#b3b3b3', yellow='#ffc107', green='#d8f0df'; let bg=green; if(it.state==='stopped') bg=gray; else if(it.state==='skip') bg=yellow; else if(it.done) bg=pink; el.style.backgroundColor=bg; }
// === Foundation: ID & Handlers ===
      const INSPECT_URL = ''; // 後で設定
      function buildItemId(it){ return [it.city||'', it.station||'', it.model||'', it.plate||''].join('|'); }

      function saveAll(items){
        try{ localStorage.setItem('junkai:items', JSON.stringify(items)); }catch(_){}
      }
      function findAndUpdate(it, upd){
        try{
          const raw = localStorage.getItem('junkai:items');
          const a = raw ? JSON.parse(raw) : [];
          const t = a.find(x=>x.city===it.city && x.station===it.station && x.model===it.model && x.plate===it.plate);
          if(t){ Object.assign(t, upd); saveAll(a); }
        }catch(__){}
      }
      function onItemChecked(it, checked){
        const now = checked ? Date.now() : null;
        it.done = checked ? 1 : 0;
        it.updatedAt = now;
        // status整合
        it.status = it.done ? '済' : (it.state==='stopped'?'停':(it.state==='skip'?'不要':''));
        findAndUpdate(it, {done:it.done, updatedAt:it.updatedAt, status:it.status});
      }
      function onStateChanged(it, newState){
        it.state = newState;
        it.status = it.done ? '済' : (it.state==='stopped'?'停':(it.state==='skip'?'不要':''));
        it.updatedAt = Date.now();
        findAndUpdate(it, {state:it.state, status:it.status, updatedAt:it.updatedAt});
      }
      function openInspection(it){
        // 後続タスクで実装予定（土台のみ）
        const q = new URLSearchParams({ station: it.station||'', model: it.model||'', plate: it.plate||'' }).toString();
        const url = (INSPECT_URL||'#') + (INSPECT_URL ? ('?'+q) : '');
        // window.location.href = url; // まだ遷移はしない
        return url;
      }
      // === /Foundation ===

      function render(){ 
        const all = migrate(load());
        const listEl = $('#list'); const emptyEl = $('#empty');
        const canon = canonCity(CITY_CANON);
        const cityItems = all.filter(it=>{
          const c = canonCity(it.city);
          return c===canon || (c && canon && c.indexOf(canon) !== -1);
        });
        if (emptyEl) emptyEl.textContent = cityItems.length? '' : 'まだ同期されていません';
        listEl.innerHTML='';
        if (!cityItems.length) { updateCounter(0,0); return; }
        let done=0; const total = cityItems.length;
        cityItems.forEach(it=>{ if(it.done) done++; });
        updateCounter(done,total);

        cityItems.forEach((it, idx)=>{
          const itemEl = document.createElement('div'); itemEl.className='item card'; itemEl.dataset.itemId = buildItemId(it); applyClass(itemEl, it); applyVisual(itemEl,it);
          const row1=document.createElement('div'); row1.className='row1';
          const left=document.createElement('div'); left.className='left';
          const lead=document.createElement('span'); lead.className='lead';
          const idxSpan=document.createElement('span'); idxSpan.className='idx'; idxSpan.textContent=String(idx+1);
          const doneBox=document.createElement('input'); doneBox.type='checkbox'; doneBox.className='checkbox'; doneBox.checked=!!it.done;
          lead.appendChild(idxSpan); lead.appendChild(doneBox);
          const stationSpan=document.createElement('span'); stationSpan.textContent = it.station||'';
          left.appendChild(lead); left.appendChild(stationSpan);
          row1.appendChild(left);
          const right=document.createElement('div'); right.className='right';
 right.className='right';
          const dateSpan=document.createElement('span'); dateSpan.className='date'; dateSpan.textContent = it.done ? fmt(it.updatedAt) : '';
          const sel = document.createElement('select'); sel.className='state-select';
          const opts = [
            {k:'normal', label:'通常'},
            {k:'stopped', label:'停止'},
            {k:'skip', label:'不要'}
          ];
          opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.k; op.textContent=o.label; sel.appendChild(op); });
          sel.value = (it.state||'normal');
          sel.addEventListener('change', ()=>{
            onStateChanged(it, sel.value);
            applyClass(itemEl,it); applyVisual(itemEl,it);
            render();
          });
          right.appendChild(sel);
          row1.appendChild(right);
          itemEl.appendChild(row1);
          const row2=document.createElement('div'); row2.className='row2';
          const spacer=document.createElement('span'); spacer.className='lead';
          const plateSpan=document.createElement('span'); plateSpan.className='kv'; plateSpan.innerHTML = `${it.plate||''}`;
          const modelSpan=document.createElement('span'); modelSpan.className='kv'; modelSpan.innerHTML = `${it.model||''}`;
          row2.appendChild(spacer); row2.appendChild(plateSpan); row2.appendChild(modelSpan);
          itemEl.appendChild(row2);
          listEl.appendChild(itemEl);
        });
      }
      document.addEventListener('DOMContentLoaded', render);
      window.addEventListener('storage', render);
    })();
  </script>


</body>
</html>