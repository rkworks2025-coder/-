<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>巡回リスト Index</title>
<link rel="stylesheet" href="style.css">
<script src="app.js"></script>
</head>
<body>
<header>
  <button class="btn back" onclick="syncFromGAS()">同期</button>
  <h1>巡回リスト</h1>
  <div style="width:64px"></div>
</header>
<main>
  <div class="toolbar">
    <div class="sub">GASと同期して各エリアに反映します</div>
    <button class="btn" onclick="updateCounts()">再計算</button>
  </div>

  <div class="card">
    <div class="checkcol"></div><div class="idx"></div>
    <div class="title"><a href="yamato.html">大和市</a></div>
    <div class="right"><div id="yamato_count" class="sub">済0/停止0/不要0/総0</div></div>
    <div class="date"></div>
  </div>
  <div class="card">
    <div class="checkcol"></div><div class="idx"></div>
    <div class="title"><a href="ebina.html">海老名市</a></div>
    <div class="right"><div id="ebina_count" class="sub">済0/停止0/不要0/総0</div></div>
    <div class="date"></div>
  </div>
  <div class="card">
    <div class="checkcol"></div><div class="idx"></div>
    <div class="title"><a href="chofu.html">調布市</a></div>
    <div class="right"><div id="chofu_count" class="sub">済0/停止0/不要0/総0</div></div>
    <div class="date"></div>
  </div>
  <div class="card">
    <div class="checkcol"></div><div class="idx"></div>
    <div class="title">全エリア合計</div>
    <div class="right"><div id="all_count" class="sub">済0/停止0/不要0/総0</div></div>
    <div class="date"></div>
  </div>
</main>
<script>
async function syncFromGAS(){
  if(!GAS_URL){ alert("app.js の GAS_URL を設定してください。"); return; }
  try{
    const res = await fetch(GAS_URL + '?action=pull', { method:'GET' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    for(const key of ['yamato','ebina','chofu']){
      const arr = Array.isArray(data[key]) ? data[key] : [];
      const items = arr.map(o => ({
        station: o.station || '',
        model: o.model || '',
        plate: o.plate || '',
        address: o.address || '',
        note: o.note || ''
      }));
      const state = {
        items,
        checked: items.map(()=>false),
        flags: items.map(()=>''),
        dates: items.map(()=>null),
        meta: []
      };
      saveCityState(key, state);
    }
    updateCounts();
    alert('同期が完了しました。各エリアページを開いて確認してください。');
  }catch(e){
    alert('同期に失敗しました。GASのCORS設定とaction=pullのレスポンス(JSON)を確認してください。\n'+e.message);
  }
}

function getState(city){ return loadCityState(city); }
function countFor(s){
  const total = s.items.length;
  let done=0, stopped=0, skip=0;
  for(let i=0;i<total;i++){
    if(s.checked[i]) done++;
    if(s.flags[i]==="stopped") stopped++;
    if(s.flags[i]==="skip") skip++;
  }
  return {done, stopped, skip, total};
}
function updateCounts(){
  const cities=['yamato','ebina','chofu'];
  let ad=0,as=0,ak=0,at=0;
  for(const c of cities){
    const s = getState(c);
    const k = countFor(s);
    ad+=k.done; as+=k.stopped; ak+=k.skip; at+=k.total;
    const el = document.getElementById(c+"_count");
    if(el) el.textContent = `済${k.done}/停止${k.stopped}/不要${k.skip}/総${k.total}`;
  }
  document.getElementById('all_count').textContent = `済${ad}/停止${as}/不要${ak}/総${at}`;
}
updateCounts();
</script>
</body>
</html>
