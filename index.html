<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>市区町村を選択</title>

<style>
  :root{ --bg:#f6f7fb; --surface:#fff; --border:#e6e8ee; --text:#111; --muted:#6b7280; }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
  header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;font-weight:700}
  main{padding:16px;max-width:720px;margin:0 auto}
  a.card{display:flex;justify-content:space-between;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;text-decoration:none;color:inherit;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .name{font-size:16px;font-weight:700}
  .count{color:var(--muted);font-variant-numeric:tabular-nums}
  .muted{color:var(--muted);margin:8px 0 16px}
  .summary{margin-top:8px;padding:12px 16px;border:1px dashed var(--border);border-radius:12px;background:#fff;display:flex;justify-content:space-between;align-items:center}
</style>

<header>市区町村を選択</header>
<main>
  <p class="muted">各市の完了数を表示します（端末内に保存されたチェック状態を集計）。</p>
  <a class="card" href="yamato.html">
    <span class="name">大和市 巡回</span>
    <span class="count" id="c-yamato">-</span>
  </a>
  <a class="card" href="ebina.html">
    <span class="name">海老名市 巡回</span>
    <span class="count" id="c-ebina">-</span>
  </a>
  <a class="card" href="chofu.html">
    <span class="name">調布市 巡回</span>
    <span class="count" id="c-chofu">-</span>
  </a>
  <div class="summary">
    <span class="name">全エリア達成度</span>
    <span class="count" id="c-all">-</span>
  </div>
</main>

<script>
const TOTALS = {"yamato": 60, "ebina": 89, "chofu": 54};
const TOTAL_ALL = 203;

function calcChecked(prefix){
  let n=0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k) continue;
    if(k.startsWith('chk:'+prefix+':')){
      try{ const v = JSON.parse(localStorage.getItem(k)); if(v && v.checked) n++; }catch(e){}
    }
  }
  return n;
}

function calcCheckedAll(){
  const prefixes = ['大和市','海老名市','調布市'];
  return prefixes.reduce((acc,p)=> acc + calcChecked(p), 0);
}

function fmt(x,y){
  const p = y ? Math.round((x/y)*100) : 0;
  return x + '/' + y + ' (' + p + '%)';
}

function update(){
  const y = calcChecked('大和市');   document.getElementById('c-yamato').textContent = fmt(y, TOTALS.yamato);
  const e = calcChecked('海老名市'); document.getElementById('c-ebina').textContent  = fmt(e, TOTALS.ebina);
  const c = calcChecked('調布市');   document.getElementById('c-chofu').textContent  = fmt(c, TOTALS.chofu);
  const a = calcCheckedAll();        document.getElementById('c-all').textContent    = fmt(a, TOTAL_ALL);
}

document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) update(); });
document.addEventListener('DOMContentLoaded', update);
</script>


<!-- ▼ JSONエクスポート／インポート -->
<div class="sync-json" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px 0;">
  <button id="jsonExportBtn" style="padding:8px 12px;border:1px solid #e6e8ee;border-radius:8px;background:#fff;">保存(JSON)</button>
  <button id="jsonImportBtn" style="padding:8px 12px;border:1px solid #e6e8ee;border-radius:8px;background:#fff;">読み込み(JSON)</button>
  <input id="jsonFileInput" type="file" accept="application/json" style="display:none;">
</div>
<script>
(function(){
  const PREFIX = ['chk:','del:','巡回:stats:'];
  function dump(){
    const obj = {};
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(PREFIX.some(p=>k.startsWith(p))){
        obj[k] = localStorage.getItem(k);
      }
    }
    return obj;
  }
  function download(name, text){
    const a = document.createElement('a');
    a.download = name;
    a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
    document.body.appendChild(a); a.click(); a.remove();
  }
  function doExport(){
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    const name = 'junkai-' + ts + '.json';
    download(name, JSON.stringify(dump(), null, 2));
    alert('JSONを保存しました');
  }
  function doImport(file){
    const r = new FileReader();
    r.onload = function(){
      try{
        const obj = JSON.parse(r.result || '{}');
        if(typeof obj !== 'object'){ alert('JSONが不正です'); return; }
        const delKeys = [];
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(PREFIX.some(p=>k.startsWith(p))) delKeys.push(k);
        }
        delKeys.forEach(k=>localStorage.removeItem(k));
        Object.entries(obj).forEach(([k,v])=> localStorage.setItem(k, v));
        alert('読み込み完了。ページを再読み込みします');
        location.reload();
      }catch(e){
        alert('読み込みエラー: ' + e.message);
      }
    };
    r.readAsText(file);
  }
  document.addEventListener('DOMContentLoaded', function(){
    const ex = document.getElementById('jsonExportBtn');
    const im = document.getElementById('jsonImportBtn');
    const fi = document.getElementById('jsonFileInput');
    if(ex) ex.addEventListener('click', doExport);
    if(im) im.addEventListener('click', function(){ fi && fi.click(); });
    if(fi) fi.addEventListener('change', function(){
      if(fi.files && fi.files[0]) doImport(fi.files[0]);
    });
  });
})();
</script>
<!-- ▲ JSONエクスポート／インポート -->
