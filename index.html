<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>巡回リスト</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="appbar">
    <div class="title">巡回リスト</div>
    <div class="btns">
      <button id="syncBtn" class="btn primary">同期</button>
      <button id="recalcBtn" class="btn">再計算</button>
    </div>
  </div>
  <div class="wrap">
    <p id="statusText" class="hint">同期してください</p>
    <section class="cards">
      <a id="card-yamato" class="card" href="yamato.html">
        <h2>大和市 巡回</h2>
        <div class="meta"><span id="yamato-count">0/0 (0%)</span></div>
      </a>
      <a id="card-ebina" class="card" href="ebina.html">
        <h2>海老名市 巡回</h2>
        <div class="meta"><span id="ebina-count">0/0 (0%)</span></div>
      </a>
      <a id="card-chofu" class="card" href="chofu.html">
        <h2>調布市 巡回</h2>
        <div class="meta"><span id="chofu-count">0/0 (0%)</span></div>
      </a>
    </section>
    <h2 class="hint" style="margin-top:20px;">全エリア達成度</h2>
    <div class="meta"><span id="overall-count">0/0 (0%)</span></div>
    <div class="actions">
      <button id="exportJson">保存(JSON)</button>
      <button id="importJson">読み込み(JSON)</button>
      <input type="file" id="jsonFile" accept=".json" style="display:none" />
    </div>
  </div>
  <div id="progressModal" class="progress-modal">
    <p id="progressMessage">同期中…</p>
    <div class="progress-bar-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>
  </div>
  <script>

  (function(){
    const LS_KEY = 'junkai:items:v2';
    function load(){ try { const s=localStorage.getItem(LS_KEY); return s? JSON.parse(s): []; } catch(e){ return []; } }
    function migrate(items){
      let changed=false;
      items.forEach(it=>{
        if (it.done===undefined || it.state===undefined){
          const st = it.status||'';
          it.done = (st==='済') ? 1 : 0;
          it.state = (st==='停') ? 'stopped' : (st==='不要' ? 'skip' : 'normal');
          changed=true;
        }
        it.status = it.done ? '済' : (it.state==='stopped' ? '停' : (it.state==='skip' ? '不要' : ''));
      });
      if (changed) localStorage.setItem(LS_KEY, JSON.stringify(items));
      return items;
    }
    function renderIndex(){
      const items = migrate(load());
      const byCity = { '大和市':[], '海老名市':[], '調布市':[] };
      items.forEach(it=>{ if (byCity[it.city]) byCity[it.city].push(it); });
      function set(id, txt){ const el = document.getElementById(id); if (el) el.textContent = txt; }
      function count(arr){ const total=arr.length; const done=arr.filter(x=>x.done).length; const pct= total? Math.floor(done*100/total):0; return `${done}/${total} (${pct}%)`; }
      set('yamato-count', count(byCity['大和市']));
      set('ebina-count', count(byCity['海老名市']));
      set('chofu-count', count(byCity['調布市']));
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const recalc = document.getElementById('recalcBtn');
      if (recalc) recalc.addEventListener('click', renderIndex);
      window.addEventListener('storage', renderIndex);
      renderIndex();
    });
  })();

</script>
</body>
</html>