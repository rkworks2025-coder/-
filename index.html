<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>巡回リスト</title>

  <style>
    :root { --accent:#2b6bf6; --fg:#0e1a2b; --muted:#64748b; --chip:#eff4ff; }
    body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin:0; background:#f6f7fb; color:var(--fg);}
    .appbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid #e6e8ef;}
    .title{font-size:20px;font-weight:800;letter-spacing:.04em;}
    .btns{display:flex;gap:10px;}
    .btn{appearance:none;border:1px solid #d7dbe7;padding:8px 14px;border-radius:12px;cursor:pointer;background:#fff;font-size:14px;display:flex;align-items:center;gap:6px;transition:.2s;}
    .btn:active{transform:scale(.95);}
    .btn.sync{border-color:var(--accent);color:var(--accent);}
    main{padding:20px 16px;}
    h1{font-size:20px;margin:0 0 10px 0;font-weight:bold;}
    .card{display:block;background:#fff;border-radius:24px;box-shadow:0 6px 16px -2px rgba(18,22,33,.08);margin:0 0 16px 0;padding:20px;border:1px solid #fff;transition:.3s;text-decoration:none;color:inherit;}
    .card h2{font-size:18px;margin:0;font-weight:700;}
    .meta{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
    .chip{font-size:12px;font-weight:500;background:var(--chip);color:var(--accent);padding:4px 10px;border-radius:6px;}
    .overall{margin-top:20px;display:flex;align-items:center;gap:8px;}
    #overallHint{font-size:14px;color:var(--muted);margin:0;}
    #overallHint.empty{font-size:14px;color:var(--accent);font-weight:600;}
    .progress-modal{position:fixed;bottom:0;left:0;width:100%;z-index:9999;transition:.3s;background:rgba(255,255,255,.9);backdrop-filter:blur(4px);padding:10px 16px;box-shadow:0 -6px 16px -2px rgba(18,22,33,.08);border-top-left-radius:24px;border-top-right-radius:24px;transform:translateY(100%);}
    .progress-modal.is-visible{transform:translateY(0%);}
    .progress-modal[hidden]{display:none;}
    .progress-bar-container{width:100%;height:6px;background:#eee;border-radius:3px;overflow:hidden;margin-top:10px;}
    .progress-bar{height:100%;background:var(--accent);transition:width .3s linear;}
  </style>
</head>
<body>
  <div class="appbar">
    <div class="title">巡回リスト</div>
    <div class="btns">
      <button id="syncBtn" class="btn sync">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 12a9 9 0 1 1-9-9c2.72 0 5.18 1.15 6.96 3L21 3"/><path d="M21 3v9h-9"/></svg>
        同期
      </button>
      <button id="recalcBtn" class="btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9v10"/><path d="M10 21h4v-4"/></svg>
        再計算
      </button>
    </div>
  </div>

  <main>
    <section>
      <h1>各エリアの集計</h1>
      <a id="card-yamato" class="card" href="yamato.html" data-city="大和市">
        <h2>大和市</h2>
        <div class="meta">
          <span class="chip">済 <span id="yamato-done">0</span></span>
          <span class="chip">停 <span id="yamato-stop">0</span></span>
          <span class="chip">不要 <span id="yamato-skip">0</span></span>
          <span class="chip">総 <span id="yamato-total">0</span></span>
        </div>
      </a>

      <a id="card-ebina" class="card" href="ebina.html" data-city="海老名市">
        <h2>海老名市</h2>
        <div class="meta">
          <span class="chip">済 <span id="ebina-done">0</span></span>
          <span class="chip">停 <span id="ebina-stop">0</span></span>
          <span class="chip">不要 <span id="ebina-skip">0</span></span>
          <span class="chip">総 <span id="ebina-total">0</span></span>
        </div>
      </a>

      <a id="card-chofu" class="card" href="chofu.html" data-city="調布市">
        <h2>調布市</h2>
        <div class="meta">
          <span class="chip">済 <span id="chofu-done">0</span></span>
          <span class="chip">停 <span id="chofu-stop">0</span></span>
          <span class="chip">不要 <span id="chofu-skip">0</span></span>
          <span class="chip">総 <span id="chofu-total">0</span></span>
        </div>
      </a>
    </section>

    <p id="overallHint" class="empty">まだ同期されていません</p>
    <p class="overall"><small>全体:</small> <span id="overallTotal">0</span></p>
  </main>

  <div id="progressModal" class="progress-modal" hidden>
    <p id="statusText">同期中...</p>
    <div class="progress-bar-container">
      <div id="progressBar" class="progress-bar" style="width:0%;"></div>
    </div>
  </div>
  
  <script>
    /* =========================
       巡回リスト app.js（最終版・エラーハンドリング強化）
       - 二重マウント防止
       - 同期/再計算ボタン結線
       - 進捗モーダル表示（擬似バー）
       - GASへ ?action=pull で取得
       - 都市別カウント反映
       - フィールド名の表記ゆれを吸収
       - エラー詳細を画面に表示
       ========================= */

    (function () {
      if (window.__JUNKAI_MOUNTED__) {
        console.warn('JunkaiApp already mounted. Skip.');
        return;
      }
      window.__JUNKAI_MOUNTED__ = true;

      const GAS_URL = 'https://script.google.com/macros/s/AKfycbzPYLa_qkxjqsW42IY5xIVjmZR-fCfgovr-jFiifQC9qKkMQ-I0TE8R2e4F1wAKzzlpYQ/exec';
      console.log('GAS URL loaded:', GAS_URL);

      const $ = (sel, root = document) => root.querySelector(sel);

      const modal = $('#progressModal');
      const bar = $('#progressBar');
      const statusText = $('#statusText');

      const cityEls = {
        yamato: { done: $('#yamato-done'), stop: $('#yamato-stop'), skip: $('#yamato-skip'), total: $('#yamato-total') },
        ebina: { done: $('#ebina-done'), stop: $('#ebina-stop'), skip: $('#ebina-skip'), total: $('#ebina-total') },
        chofu: { done: $('#chofu-done'), stop: $('#chofu-stop'), skip: $('#chofu-skip'), total: $('#chofu-total') },
      };

      const overallHint = $('#overallHint');
      const totalCount = $('#overallTotal');

      let latestRows = [];

      function showProgress(message) {
        if (modal) {
          modal.hidden = false;
          bar.style.width = '0%';
          if (statusText) statusText.textContent = message;
        }
      }

      function closeProgress() {
        if (modal) {
          setTimeout(() => {
            modal.hidden = true;
          }, 500);
        }
      }

      function computeCounts(rows) {
        const counts = {
          yamato: { done: 0, stop: 0, skip: 0, total: 0 },
          ebina: { done: 0, stop: 0, skip: 0, total: 0 },
          chofu: { done: 0, stop: 0, skip: 0, total: 0 },
          overall: 0,
        };

        if (!Array.isArray(rows)) {
          console.warn('Expected array data for counting, but got:', rows);
          return counts;
        }

        for (const row of rows) {
          const city = row.city || row.City;
          const status = row.status || row.Status;

          if (city === '大和市' && counts.yamato) {
            counts.yamato.total++;
            if (status === '済') counts.yamato.done++;
            else if (status === '停') counts.yamato.stop++;
            else if (status === '不要') counts.yamato.skip++;
          } else if (city === '海老名市' && counts.ebina) {
            counts.ebina.total++;
            if (status === '済') counts.ebina.done++;
            else if (status === '停') counts.ebina.stop++;
            else if (status === '不要') counts.ebina.skip++;
          } else if (city === '調布市' && counts.chofu) {
            counts.chofu.total++;
            if (status === '済') counts.chofu.done++;
            else if (status === '停') counts.chofu.stop++;
            else if (status === '不要') counts.chofu.skip++;
          }
        }
        counts.overall = rows.length;
        return counts;
      }

      function renderCounts(counts) {
        for (const city in counts) {
          if (cityEls[city]) {
            cityEls[city].done.textContent = counts[city].done;
            cityEls[city].stop.textContent = counts[city].stop;
            cityEls[city].skip.textContent = counts[city].skip;
            cityEls[city].total.textContent = counts[city].total;
          }
        }
        if (totalCount) {
          totalCount.textContent = counts.overall;
          overallHint.classList.remove('empty');
        }
      }

      async function doSync() {
        showProgress('同期を開始しています...');
        bar.style.width = '30%';

        try {
          const resp = await fetch(GAS_URL + '?action=pull');
          bar.style.width = '70%';

          if (!resp.ok) {
            const errorText = await resp.text();
            throw new Error(`HTTP Error! status: ${resp.status}, message: ${errorText}`);
          }

          const responseJson = await resp.json();
          if (responseJson.ok === false) {
            throw new Error(`GASエラー: ${responseJson.error}`);
          }
          
          const data = responseJson.data;
          if (!Array.isArray(data)) {
            throw new Error('返されたデータが配列ではありません。');
          }

          latestRows = data;
          const counts = computeCounts(latestRows);
          renderCounts(counts);
          if (statusText) statusText.textContent = '同期完了！';

        } catch (err) {
          console.error('同期処理エラー:', err);
          if (statusText) statusText.textContent = `同期エラー：${err.message ?? err}`;
          bar.style.width = '0%';
        } finally {
          closeProgress();
        }
      }

      function doRecalc() {
        showProgress('再計算中...');
        const counts = computeCounts(latestRows || []);
        renderCounts(counts);
        if (statusText) statusText.textContent = '再計算完了';
        closeProgress();
      }

      function bindButtons() {
        const syncBtn = $('#syncBtn');
        const recalcBtn = $('#recalcBtn');

        if (syncBtn && !syncBtn.dataset.bound) {
          syncBtn.addEventListener('click', doSync, { passive: true });
          syncBtn.dataset.bound = '1';
        }
        if (recalcBtn && !recalcBtn.dataset.bound) {
          recalcBtn.addEventListener('click', doRecalc, { passive: true });
          recalcBtn.dataset.bound = '1';
        }
      }

      function mountIndex() {
        bindButtons();
        if (statusText) statusText.textContent = 'GASと同期して各エリアに反映します。';
      }

      if (document.title === '巡回リスト') {
        mountIndex();
      }
    })();
  </script>
</body>
</html>
