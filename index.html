
<style>
.ver{position:fixed;right:8px;bottom:6px;font-size:10px;color:#94a3b8;opacity:.7;pointer-events:none;z-index:9}
.btn.tiny{padding:6px 10px;font-size:12px;border-radius:8px}
.inspect-btn{border:1px solid #d1d5db;background:#fff}
.when{margin-left:8px;display:flex;flex-direction:column;line-height:1.0}
.when .md{font-size:12px;color:#0f172a}
.when .hm{font-size:11px;color:#64748b;margin-top:2px}
.idx{width:28px;display:inline-block;text-align:right;font-variant-numeric:tabular-nums;color:#94a3b8;margin-right:6px}
.legacy-bulk,.edit-hint{display:none!important}
</style>
<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>市区町村を選択</title>

<style>
  :root{ --bg:#f6f7fb; --surface:#fff; --border:#e6e8ee; --text:#111; --muted:#6b7280; }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
  header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;font-weight:700}
  main{padding:16px;max-width:720px;margin:0 auto}
  a.card{display:flex;justify-content:space-between;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;text-decoration:none;color:inherit;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .name{font-size:16px;font-weight:700}
  .count{color:var(--muted);font-variant-numeric:tabular-nums}
  .muted{color:var(--muted);margin:8px 0 16px}
  .summary{margin-top:8px;padding:12px 16px;border:1px dashed var(--border);border-radius:12px;background:#fff;display:flex;justify-content:space-between;align-items:center}
</style>

<header>市区町村を選択</header>
<main>
  <p class="muted">各市の完了数を表示します（端末内に保存されたチェック状態を集計）。</p>
  <a class="card" href="yamato.html">
    <span class="name">大和市 巡回</span>
    <span class="count" id="c-yamato">-</span>
  </a>
  <a class="card" href="ebina.html">
    <span class="name">海老名市 巡回</span>
    <span class="count" id="c-ebina">-</span>
  </a>
  <a class="card" href="chofu.html">
    <span class="name">調布市 巡回</span>
    <span class="count" id="c-chofu">-</span>
  </a>
  <div class="summary">
    <span class="name">全エリア達成度</span>
    <span class="count" id="c-all">-</span>
  </div>
</main>

<script>
const TOTALS = {"yamato": 60, "ebina": 89, "chofu": 54};
const TOTAL_ALL = 203;

function calcChecked(prefix){
  let n=0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k) continue;
    if(k.startsWith('chk:'+prefix+':')){
      try{ const v = JSON.parse(localStorage.getItem(k)); if(v && v.checked) n++; }catch(e){}
    }
  }
  return n;
}

function calcCheckedAll(){
  const prefixes = ['大和市','海老名市','調布市'];
  return prefixes.reduce((acc,p)=> acc + calcChecked(p), 0);
}

function fmt(x,y){
  const p = y ? Math.round((x/y)*100) : 0;
  return x + '/' + y + ' (' + p + '%)';
}

function update(){
  const y = calcChecked('大和市');   document.getElementById('c-yamato').textContent = fmt(y, TOTALS.yamato);
  const e = calcChecked('海老名市'); document.getElementById('c-ebina').textContent  = fmt(e, TOTALS.ebina);
  const c = calcChecked('調布市');   document.getElementById('c-chofu').textContent  = fmt(c, TOTALS.chofu);
  const a = calcCheckedAll();        document.getElementById('c-all').textContent    = fmt(a, TOTAL_ALL);
}

document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) update(); });
document.addEventListener('DOMContentLoaded', update);
</script>

<div class="ver">v2</div>
<script>
(function(){
  function removeLegacyUI(){
    const texts = ["全てチェック","全て外す","リセット","日付を編集","日付を編集→","日付を編集 → 各行の日付ラベルをタップ"];
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
    const toRemove = [];
    while(walker.nextNode()){
      const el = walker.currentNode;
      const t = (el.textContent||"").trim();
      if (!t) continue;
      for(const kw of texts){
        if(t.includes(kw)){
          el.classList.add('legacy-bulk');
          toRemove.push(el);
          break;
        }
      }
    }
    toRemove.forEach(el=>el.remove());
    document.querySelectorAll('.legacy-bulk,.edit-hint').forEach(el=>el.remove());
  }

  function addIndices(){
    const rows = Array.from(document.querySelectorAll('.row, .card-row, .card, li'));
    let n = 1;
    rows.forEach(row=>{
      if(row.querySelector('.idx')) return;
      const cb = row.querySelector('input[type=\"checkbox\"]');
      if(!cb) return;
      const span = document.createElement('span');
      const di = row.getAttribute('data-index');
      span.className = 'idx';
      span.textContent = String(di && /^\d+$/.test(di) ? di : n++);
      cb.parentNode.insertBefore(span, cb);
    });
  }

  function splitDateTimeTwoLines(){
    const candidates = document.querySelectorAll('.timestamp, .time, .date, .when, [data-timestamp]');
    candidates.forEach(el=>{
      const raw = (el.getAttribute('data-timestamp') || el.textContent || '').trim();
      if (el.classList && el.classList.contains('when')) return;
      let m = raw.match(/(\d{1,2})[\/\-\.](\d{1,2})[ T](\d{1,2}):(\d{2})/);
      if (!m) {
        m = raw.match(/\d{4}\-\d{1,2}\-(\d{1,2})[T ](\d{1,2}):(\d{2})/);
        if (m) { m = [null, m[1], null, m[2], m[3]]; }
      }
      if (!m) return;
      const mm = (m[1]||'').toString().padStart(2,'0');
      const dd = (m[2]||'').toString().padStart(2,'0');
      const hh = (m[3]||'').toString().padStart(2,'0');
      const mi = (m[4]||'').toString().padStart(2,'0');
      const wrap = document.createElement('div');
      wrap.className = 'when';
      const d1 = document.createElement('div'); d1.className = 'md'; d1.textContent = mm + "/" + dd;
      const d2 = document.createElement('div'); d2.className = 'hm'; d2.textContent = hh + ":" + mi;
      wrap.appendChild(d1); wrap.appendChild(d2);
      el.replaceWith(wrap);
    });
  }

  function addInspectButtons(){
    const rows = Array.from(document.querySelectorAll('.row, .card-row, .card, li'));
    rows.forEach(row=>{
      if (row.querySelector('.inspect-btn')) return;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn tiny inspect-btn';
      btn.textContent = '点検';
      btn.addEventListener('click', (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        const station = (row.getAttribute('data-station') || '').trim();
        const model = (row.getAttribute('data-model') || '').trim();
        const number = (row.getAttribute('data-number') || '').trim();
        console.log('inspect(params):', {station, model, number});
      });
      row.appendChild(btn);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>{
      removeLegacyUI();
      addIndices();
      splitDateTimeTwoLines();
      addInspectButtons();
    }, {once:true});
  } else {
    removeLegacyUI();
    addIndices();
    splitDateTimeTwoLines();
    addInspectButtons();
  }
})();
</script>

<script>
(function(){
  function dedupeById(id){
    const list = document.querySelectorAll('#'+id);
    if(list.length<=1) return;
    for(let i=1;i<list.length;i++) list[i].remove();
  }
  function dedupeByLabel(txt){
    const btns = Array.from(document.querySelectorAll('button, a'));
    const matches = btns.filter(b => (b.textContent||'').trim() === txt);
    for(let i=1;i<matches.length;i++) matches[i].remove();
  }
  function run(){
    dedupeById('recalcBtn');
    dedupeById('syncBtn');
    dedupeByLabel('再計算');
    dedupeByLabel('同期');
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, {once:true});
  } else {
    run();
  }
})();
</script>
