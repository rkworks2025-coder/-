<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>市区町村を選択</title>

<style>
  :root{ --bg:#f6f7fb; --surface:#fff; --border:#e6e8ee; --text:#111; --muted:#6b7280; }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
  header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;font-weight:700;z-index:10}
  main{padding:16px;max-width:720px;margin:0 auto}
  a.card{display:flex;justify-content:space-between;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;text-decoration:none;color:inherit;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .name{font-size:16px;font-weight:700}
  .count{color:var(--muted);font-variant-numeric:tabular-nums}
  .muted{color:var(--muted);margin:8px 0 16px}
  .summary{margin-top:8px;padding:12px 16px;border:1px dashed var(--border);border-radius:12px;background:#fff;display:flex;justify-content:space-between;align-items:center}
  .ver{position:fixed;right:8px;bottom:6px;font-size:10px;color:#94a3b8;opacity:.7;pointer-events:none;z-index:9}
</style>

<header>市区町村を選択</header>
<main>
  <p class="muted">各市の完了数を表示します（端末内に保存されたチェック状態を集計）。</p>
  <a class="card" href="yamato.html" data-city="大和市">
    <span class="name">大和市 巡回</span>
    <span class="count" id="c-大和市">-</span>
  </a>
  <a class="card" href="ebina.html" data-city="海老名市">
    <span class="name">海老名市 巡回</span>
    <span class="count" id="c-海老名市">-</span>
  </a>
  <a class="card" href="chofu.html" data-city="調布市">
    <span class="name">調布市 巡回</span>
    <span class="count" id="c-調布市">-</span>
  </a>
  <div class="summary">
    <span class="name">全エリア達成度</span>
    <span class="count" id="c-all">-</span>
  </div>
</main>

<script>
// Apps Script endpoint provided by the user
const GAS_URL = 'https://script.google.com/macros/s/AKfycby9RpFiUbYu6YX6JW9XfwbDx36_4AIlGEQMOxR3SnxgNdoRUJKfyxvF3b1SEYwuHb3X/exec';

async function fetchRecords(){
  try{
    const res = await fetch(GAS_URL + '?action=pull');
    const json = await res.json();
    let records=[];
    if(Array.isArray(json.data) && json.data.length){
      const first = json.data[0];
      // If first element is an array, treat as header row
      if(Array.isArray(first)){
        const headers = first;
        for(let i=1;i<json.data.length;i++){
          const row = json.data[i];
          let obj = {};
          headers.forEach((h, idx) => { obj[h] = row[idx]; });
          records.push(obj);
        }
      } else {
        // assume array of objects
        records = json.data;
      }
    }
    return records;
  } catch(e){
    console.error(e);
    return [];
  }
}

function calcChecked(city){
  let n = 0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith('chk:'+city+':')){
      try{ const v = JSON.parse(localStorage.getItem(k)); if(v && v.checked) n++; }catch(e){}
    }
  }
  return n;
}

function fmt(x,y){
  const p = y ? Math.round((x*100)/y) : 0;
  return `${x}/${y} (${p}%)`;
}

async function updateCounts(){
  const data = await fetchRecords();
  const groups = { '大和市':0, '海老名市':0, '調布市':0 };
  data.forEach(rec => { const city = rec['city'] || rec['市区町村'] || rec['市名'] || rec['City']; if(city && groups.hasOwnProperty(city)){ groups[city]++; }});
  let total=0, checkedTotal=0;
  for(const city in groups){
    total += groups[city];
    const c = calcChecked(city);
    checkedTotal += c;
    document.getElementById('c-'+city).textContent = fmt(c, groups[city]);
  }
  document.getElementById('c-all').textContent = fmt(checkedTotal, total);
}

document.addEventListener('DOMContentLoaded', updateCounts);
</script>

<div class="ver">v4</div>
</html>