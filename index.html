<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>市区町村を選択</title>

<style>
  :root{ --bg:#f6f7fb; --surface:#fff; --border:#e6e8ee; --text:#111; --muted:#6b7280; }
  body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
  header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;font-weight:700}
  main{padding:16px;max-width:720px;margin:0 auto}
  a.card{display:flex;justify-content:space-between;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;text-decoration:none;color:inherit;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .name{font-size:16px;font-weight:700}
  .count{color:var(--muted);font-variant-numeric:tabular-nums}
  .muted{color:var(--muted);margin:8px 0 16px}
  .summary{margin-top:8px;padding:12px 16px;border:1px dashed var(--border);border-radius:12px;background:#fff;display:flex;justify-content:space-between;align-items:center}
</style>

<header>市区町村を選択</header>
<main>
  <p class="muted">各市の完了数を表示します（端末内に保存されたチェック状態を集計）。</p>
  <a class="card" href="yamato.html">
    <span class="name">大和市 巡回</span>
    <span class="count" id="c-yamato">-</span>
  </a>
  <a class="card" href="ebina.html">
    <span class="name">海老名市 巡回</span>
    <span class="count" id="c-ebina">-</span>
  </a>
  <a class="card" href="chofu.html">
    <span class="name">調布市 巡回</span>
    <span class="count" id="c-chofu">-</span>
  </a>
  <div class="summary">
    <span class="name">全エリア達成度</span>
    <span class="count" id="c-all">-</span>
  </div>
</main>

<script>
(function(){
  // Prefer stats saved by each city page (exclusion-aware). Fallback to legacy counter.
  var CITY_MAP = [
    {jp:'大和市', id:'yamato', el:'c-yamato', defaultTotal:60},
    {jp:'海老名市', id:'ebina',  el:'c-ebina',  defaultTotal:89},
    {jp:'調布市', id:'chofu',   el:'c-chofu',   defaultTotal:54},
  ];

  function readStatsForCity(jp, fallbackTotal){
    try{
      var raw = localStorage.getItem('巡回:stats:' + jp);
      if(raw){
        var obj = JSON.parse(raw);
        if(typeof obj.checked === 'number' && typeof obj.total === 'number'){
          return {checked: obj.checked, total: obj.total};
        }
      }
    }catch(e){}
    // fallback: legacy scan by key prefix 'chk:市名:'
    var checked = 0;
    for(var i=0;i<localStorage.length;i++){
      var k = localStorage.key(i);
      if(k && k.indexOf('chk:' + jp + ':') === 0){
        try{ var v = JSON.parse(localStorage.getItem(k)); if(v && v.checked) checked++; }catch(e){}
      }
    }
    return {checked: checked, total: fallbackTotal};
  }

  function fmt(x,y){
    var p = y ? Math.round((x/y)*100) : 0;
    return x + '/' + y + ' (' + p + '%)';
  }

  function update(){
    var allX = 0, allY = 0;
    CITY_MAP.forEach(function(c){
      var s = readStatsForCity(c.jp, c.defaultTotal);
      allX += s.checked; allY += s.total;
      var el = document.getElementById(c.el);
      if(el) el.textContent = fmt(s.checked, s.total);
    });
    var all = document.getElementById('c-all');
    if(all) all.textContent = fmt(allX, allY);
  }

  document.addEventListener('visibilitychange', function(){ if(!document.hidden) update(); });
  document.addEventListener('DOMContentLoaded', update);
})();
</script>

