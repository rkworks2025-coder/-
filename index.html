<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>巡回リスト</title>

  <!-- キャッシュ強め対策：バージョンクエリ -->
  <link rel="stylesheet" href="style.css?v=20250830" />
  <style>
    /* 万一 style.css が読めない時の最低限フォールバック */
    :root{--accent:#2b6bf6;--fg:#0e1a2b;--muted:#64748b;--chip:#eff4ff;}
    html,body{margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#f6f7fb;color:var(--fg)}
    .appbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid #e6e8ef}
    .title{font-size:20px;font-weight:800;letter-spacing:.04em}
    .btns{display:flex;gap:10px}
    .btn{appearance:none;border:1px solid #d7dbe7;padding:8px 14px;border-radius:12px;background:#fff;font-weight:700;font-size:14px}
    .btn-primary{background:var(--chip);border-color:#c9d6ff;color:#1e40af}
    .wrap{max-width:820px;margin:18px auto;padding:0 14px 60px}
    .hint{margin:6px 2px 14px;color:var(--muted);font-size:13px}
    .cards{display:grid;grid-template-columns:1fr;gap:14px}
    .card{display:block;text-decoration:none;color:inherit;background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:18px 16px;box-shadow:0 1px 0 rgba(8,15,35,.03)}
    .card:hover{background:#fafcff}
    .card h2{margin:0 0 8px 0;font-size:18px;letter-spacing:.03em}
    .meta{display:flex;gap:14px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#f2f5fb;border:1px solid #e6e8ef}
    .empty{margin:28px 2px 0 2px;color:var(--muted);font-size:14px}

    /* 進捗モーダル */
    .modal{position:fixed;inset:0;background:rgba(8,15,35,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.show{display:flex}
    .dialog{width:min(520px,90vw);background:#111827;color:#fff;border-radius:14px;padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .barwrap{height:8px;background:#1f2937;border-radius:999px;overflow:hidden;margin-top:12px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399)}
    .dialog h3{margin:0 0 8px 0;font-size:18px}
  </style>
</head>
<body>
  <!-- ヘッダー（重複生成を避けるため固定） -->
  <header class="appbar">
    <div class="title">巡回リスト</div>
    <div class="btns">
      <button id="recalcBtn" class="btn">再計算</button>
      <button id="syncBtn" class="btn btn-primary">同期</button>
    </div>
  </header>

  <main class="wrap">
    <p id="statusText" class="hint">GASと同期して各エリアに反映します。</p>

    <section id="cityCards" class="cards">
      <a id="card-yamato" class="card" href="yamato.html" data-city="大和市">
        <h2>大和市</h2>
        <div class="meta">
          <span class="chip">済 <span id="yamato-done">0</span></span>
          <span class="chip">停 <span id="yamato-stop">0</span></span>
          <span class="chip">不要 <span id="yamato-skip">0</span></span>
          <span class="chip">総 <span id="yamato-total">0</span></span>
        </div>
      </a>

      <a id="card-ebina" class="card" href="ebina.html" data-city="海老名市">
        <h2>海老名市</h2>
        <div class="meta">
          <span class="chip">済 <span id="ebina-done">0</span></span>
          <span class="chip">停 <span id="ebina-stop">0</span></span>
          <span class="chip">不要 <span id="ebina-skip">0</span></span>
          <span class="chip">総 <span id="ebina-total">0</span></span>
        </div>
      </a>

      <a id="card-chofu" class="card" href="chofu.html" data-city="調布市">
        <h2>調布市</h2>
        <div class="meta">
          <span class="chip">済 <span id="chofu-done">0</span></span>
          <span class="chip">停 <span id="chofu-stop">0</span></span>
          <span class="chip">不要 <span id="chofu-skip">0</span></span>
          <span class="chip">総 <span id="chofu-total">0</span></span>
        </div>
      </a>
    </section>

    <p id="overallHint" class="empty">まだ同期されていません</p>
  </main>

  <!-- 同期中モーダル -->
  <div id="progressModal" class="modal" aria-hidden="true">
    <div class="dialog">
      <h3 id="progressTitle">同期中…</h3>
      <div class="barwrap"><div id="progressBar" class="bar"></div></div>
    </div>
  </div>

  <!-- 内蔵 app.js 相当（配列の配列に対応 & ボタン二重バインド防止） -->
  <script>
    const GAS_URL =
      'https://script.google.com/macros/s/AKfycbzPYLa_qkxjqsW42IY5xIVjmZR-fCfgovr-jFiifQC9qKkMQ-I0TE8R2e4F1wAKzzlpYQ/exec';

    const els = {
      syncBtn:     document.getElementById('syncBtn'),
      recalcBtn:   document.getElementById('recalcBtn'),
      statusText:  document.getElementById('statusText'),
      progress:    document.getElementById('progressModal'),
      bar:         document.getElementById('progressBar'),
      overallHint: document.getElementById('overallHint'),
      yamato: { done:'#yamato-done', stop:'#yamato-stop', skip:'#yamato-skip', total:'#yamato-total' },
      ebina : { done:'#ebina-done',  stop:'#ebina-stop',  skip:'#ebina-skip',  total:'#ebina-total'  },
      chofu : { done:'#chofu-done',  stop:'#chofu-stop',  skip:'#chofu-skip',  total:'#chofu-total'  },
    };
    function $(s){return document.querySelector(s)}
    function setText(sel,v){const n=$(sel); if(n) n.textContent=String(v)}

    function showModal(title){
      document.getElementById('progressTitle').textContent = title||'同期中…';
      els.progress.classList.add('show');
      let t=0; els._timer=setInterval(()=>{t=(t+7)%100; els.bar.style.width=t+'%'},80);
    }
    function hideModal(title){
      if(title) document.getElementById('progressTitle').textContent=title;
      if(els._timer){clearInterval(els._timer); els._timer=null;}
      setTimeout(()=>{els.progress.classList.remove('show'); els.bar.style.width='0%'},300);
    }

    function resetTotals(){
      ['yamato','ebina','chofu'].forEach(k=>{
        setText(els[k].done,0); setText(els[k].stop,0); setText(els[k].skip,0); setText(els[k].total,0);
      });
      els.overallHint.textContent='まだ同期されていません';
    }

    async function handleSync(){
      try{
        showModal('同期中…');
        els.statusText.textContent='GAS から巡回データを取得しています…';

        const url = `${GAS_URL}?action=pull&ts=${Date.now()}`;
        const res = await fetch(url,{cache:'no-store'});
        const json = await res.json();

        if(!json || !json.ok || !Array.isArray(json.data)){
          throw new Error('GAS の戻り値が想定外です');
        }

        const cnt = {
          '大和市':{done:0,stop:0,skip:0,total:0},
          '海老名市':{done:0,stop:0,skip:0,total:0},
          '調布市':{done:0,stop:0,skip:0,total:0},
        };

        // ここが肝：配列の配列 → city は row[0]
        json.data.forEach(row=>{
          const city = row && row[0] ? String(row[0]).trim() : '';
          if (city in cnt) cnt[city].total += 1;
        });

        setText(els.yamato.total, cnt['大和市'].total);
        setText(els.ebina.total,  cnt['海老名市'].total);
        setText(els.chofu.total,  cnt['調布市'].total);

        const overall = cnt['大和市'].total + cnt['海老名市'].total + cnt['調布市'].total;
        els.overallHint.textContent = overall>0 ? '' : 'まだ同期されていません';

        els.statusText.textContent = `同期完了：大和 ${cnt['大和市'].total} / 海老名 ${cnt['海老名市'].total} / 調布 ${cnt['調布市'].total}`;
        hideModal('同期完了！');
      }catch(err){
        console.error(err);
        els.statusText.textContent='同期に失敗しました。コンソールを確認してください。';
        hideModal('同期失敗');
        alert('同期に失敗しました：' + (err?.message||'不明なエラー'));
      }
    }

    function handleRecalc(){
      els.statusText.textContent='再計算しました。';
    }

    // 重複バインド防止（UI が二重に見える原因のひとつ対策）
    if (els.syncBtn && !els.syncBtn._wired){ els.syncBtn.addEventListener('click', handleSync); els.syncBtn._wired=true; }
    if (els.recalcBtn && !els.recalcBtn._wired){ els.recalcBtn.addEventListener('click', handleRecalc); els.recalcBtn._wired=true; }

    // 初期化
    resetTotals();
  </script>
</body>
</html>