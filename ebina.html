<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>海老名市 巡回リスト</title>
<link rel="stylesheet" href="style.css">
<script src="app.js"></script>
</head>
<body>
<header><h1>海老名市 巡回リスト</h1></header>
<main id="list"></main>
<div class="counter">
  <button class="btn" onclick="onImport()">データ読み込み</button>
  <div id="count">済0/停止0/不要0/総0</div>
  <a class="btn" href="index.html">← 戻る</a>
</div>
<script>
const CITY_ID = "ebina";
const CITY_KEY = "junkai_" + CITY_ID;
const CONFIRM_MSG = "よろしいですか？"; // ON/OFFとも確認

function loadState(){
  try{
    return JSON.parse(localStorage.getItem(CITY_KEY)) || {
      items:[{station:"ステーション001",model:"-",plate:"-"},{station:"ステーション002",model:"-",plate:"-"}],
      checked:[false,false],
      flags:["",""],
      dates:[null,null],
      meta:[]
    };
  }catch(e){
    return { items:[{station:"ステーション001",model:"-",plate:"-"},{station:"ステーション002",model:"-",plate:"-"}],
             checked:[false,false], flags:["",""], dates:[null,null], meta:[] };
  }
}
function saveState(s){ localStorage.setItem(CITY_KEY, JSON.stringify(s)); }
let state = loadState();

const listEl = document.getElementById("list");

function render(sortOnLoad=false){
  listEl.innerHTML = "";
  const order = sortOnLoad ? getSortedIndices(state) : [...Array(state.items.length).keys()];
  for(let viewIdx=0; viewIdx<order.length; viewIdx++){
    const i = order[viewIdx];
    const item = state.items[i] || {station:"",model:"",plate:""};
    const checked = !!state.checked[i];
    const flag = state.flags[i] || "";
    const ts = state.dates[i];

    const row = document.createElement("div");
    let cls = "card ";
    if(flag==="stopped") cls += "stopped ";
    else if(flag==="skip") cls += "skip ";
    else if(checked) cls += "checked ";
    else if(sevenRule(ts)) cls += "seven ";
    row.className = cls.trim();

    // 左端：インデックス番号（1始まり・表示順基準）
    const idx = document.createElement("div"); idx.className="idx"; idx.textContent = (viewIdx+1);
    // チェックボタン
    const chkCol = document.createElement("div"); chkCol.className="checkcol";
    const btnChk = document.createElement("button");
    btnChk.textContent = checked? "✔":"□";
    btnChk.onclick = ()=>toggle(i);
    chkCol.appendChild(btnChk);

    // タイトル＆サブ
    const title = document.createElement("div"); title.className="title"; title.textContent = item.station || "";
    const sub = document.createElement("div"); sub.className="sub"; sub.textContent = (item.model||"") + "　" + (item.plate||"");

    // 右：状態ボタン
    const right = document.createElement("div"); right.className="right";
    const btnFlag = document.createElement("button"); btnFlag.className="btn"; btnFlag.textContent="状態"; btnFlag.onclick=()=>setFlag(i);
    right.appendChild(btnFlag);

    // 日付バッジ（MM/DD + HH:MM JST）
    const date = document.createElement("div"); date.className="date"; date.textContent = fmtDateJST(ts);

    row.appendChild(idx);
    row.appendChild(chkCol);
    const wrap = document.createElement("div");
    wrap.appendChild(title); wrap.appendChild(sub);
    row.appendChild(wrap);
    row.appendChild(right);
    row.appendChild(date);

    listEl.appendChild(row);
  }
  updateCount();
}

function toggle(i){
  const was = !!state.checked[i];
  if(!confirm(CONFIRM_MSG)) return; // ON/OFF 共通で確認
  if(!was){
    state.checked[i] = true;
    state.dates[i] = Date.now();
    saveState(state);
    sendGAS({event:"check_on", city: CITY_ID, index: i+1,
             station: state.items[i]?.station || "", model: state.items[i]?.model || "",
             plate_full: state.items[i]?.plate || "", date_badge: fmtDateJST(state.dates[i])});
  }else{
    state.checked[i] = false;
    state.dates[i] = null;
    saveState(state);
  }
  render(false); // 並び替えはリロード時（= 初回 render(true)）
}

function setFlag(i){
  const v = prompt("状態を選択：\n0=通常（薄緑）\n1=稼働停止（グレー）\n2=巡回不要（黄色）", "0");
  if(v===null) return;
  if(v==="1") state.flags[i]="stopped";
  else if(v==="2") state.flags[i]="skip";
  else state.flags[i]="";
  saveState(state);
  render(false);
}

// カウンター
function updateCount(){
  const k = computeCounters(state);
  document.getElementById("count").textContent = `済${k.done}/停止${k.stopped}/不要${k.skip}/総${k.total}`;
}

// データ読み込み（Excel貼り付け）
function onImport(){
  const text = prompt("Excelから「ステーション名,車種,フルナンバー」の行を\nそのまま貼り付けてください。\n（タブ区切り/カンマ区切りどちらでも可）", "");
  if(!text) return;
  const items = parsePasted(text);
  if(items.length===0){ alert("読み込める行がありませんでした。"); return; }
  state.items = items;
  state.checked = items.map(()=>false);
  state.flags = items.map(()=>"" );
  state.dates = items.map(()=>null);
  saveState(state);
  render(true); // 取込直後は初回ルールに倣って並び替え適用
}

render(true); // 初回（=リロード時）は並び替え適用
</script>
</body>
</html>
