const GAS_URL="https://script.google.com/macros/s/AKfycbytPvlFPvOmcaNr0u4LgLqG7VWYOa9oFz6HjV00RaNv1zTMRlzLyuv-X1a5qVH7bqVY0w/exec";
const App={};
App.ensureOverlay=function(){let ov=document.getElementById("syncOverlay");if(!ov){ov=document.createElement("div");ov.id="syncOverlay";ov.innerHTML=`<div id="syncBox"><div id="syncText"></div><div id="syncBarWrap"><div id="syncBar"></div></div></div>`;document.body.appendChild(ov);}return ov;};
App.showOverlay=function(msg,pct){App.ensureOverlay().style.display="flex";App.setOverlay(msg,pct);};
App.hideOverlay=function(){const ov=document.getElementById("syncOverlay");if(ov)ov.style.display="none";};
App.setOverlay=function(msg,pct){const t=document.getElementById("syncText");if(t)t.textContent=msg||"";const b=document.getElementById("syncBar");if(b)b.style.width=(Math.max(0,Math.min(100,pct||0)))+'%';};
App.getData=function(city){const k=city==="yamato"?"data_yamato":city==="ebina"?"data_ebina":"data_chofu";try{return JSON.parse(localStorage.getItem(k)||"[]");}catch(_ ){return[];}};
App.setDataAll=function(o){localStorage.setItem('data_yamato',JSON.stringify(o.yamato||[]));localStorage.setItem('data_ebina',JSON.stringify(o.ebina||[]));localStorage.setItem('data_chofu',JSON.stringify(o.chofu||[]));localStorage.setItem('data_updatedAt',o.updatedAt||new Date().toISOString());};
App.getState=function(city){const key="state_"+city;let st;try{st=JSON.parse(localStorage.getItem(key)||"{}");}catch(_ ){st={};}const n=App.getData(city).length;st.checked=Array.isArray(st.checked)?st.checked.slice(0,n):[];st.flags=Array.isArray(st.flags)?st.flags.slice(0,n):[];st.dates=Array.isArray(st.dates)?st.dates.slice(0,n):[];while(st.checked.length<n)st.checked.push(false);while(st.flags.length<n)st.flags.push("");while(st.dates.length<n)st.dates.push(null);localStorage.setItem(key,JSON.stringify(st));return st;};
App.setState=function(city,st){localStorage.setItem("state_"+city,JSON.stringify(st));};
App.computeCounters=function(city){const items=App.getData(city);const st=App.getState(city);const n=items.length;let d=0,stp=0,sk=0;for(let i=0;i<n;i++){if(st.checked[i])d++;if(st.flags[i]==="stopped")stp++;if(st.flags[i]==="skip")sk++;}return{done:d,stopped:stp,skip:sk,total:n};};
App.badgeHTML=function(k){return`<span class="badge done">済 ${k.done}</span><span class="badge stop">停 ${k.stopped}</span><span class="badge skip">不 ${k.skip}</span><span class="badge total">総 ${k.total}</span>`};
App.updateIndexCounts=function(){const cs=["yamato","ebina","chofu"];let ad=0,as=0,ak=0,at=0;for(const c of cs){const k=App.computeCounters(c);ad+=k.done;as+=k.stopped;ak+=k.skip;at+=k.total;const el=document.getElementById(c+"_count");if(el)el.innerHTML=App.badgeHTML(k);}const all=document.getElementById("all_count");if(all)all.innerHTML=App.badgeHTML({done:ad,stopped:as,skip:ak,total:at});const ph=document.getElementById("placeholder");const ua=localStorage.getItem("data_updatedAt");if(ph)ph.style.display=ua?"none":"block";};
App.doSync=async function(){App.showOverlay("同期開始…",10);try{const res=await fetch(GAS_URL+(GAS_URL.includes("?")?"&":"?")+"action=pull");if(!res.ok)throw new Error(`HTTP ${res.status} ${res.statusText}`);let obj;const ct=res.headers.get("content-type")||"";if(ct.includes("application/json"))obj=await res.json();else{const txt=await res.text();try{obj=JSON.parse(txt);}catch{throw new Error("JSON以外のレスポンス");}}if(!obj||obj.ok!==true)throw new Error("ok!=true");const d=obj.data;if(!d||!Array.isArray(d.yamato)||!Array.isArray(d.ebina)||!Array.isArray(d.chofu))throw new Error("data配列不正");App.setDataAll({yamato:d.yamato,ebina:d.ebina,chofu:d.chofu,updatedAt:d.updatedAt});["yamato","ebina","chofu"].forEach(App.getState);App.updateIndexCounts();const ny=d.yamato.length,ne=d.ebina.length,nc=d.chofu.length;App.setOverlay(`同期完了！ 取り込み：大和 ${ny} / 海老名 ${ne} / 調布 ${nc}`,100);setTimeout(App.hideOverlay,600);return true;}catch(e){App.hideOverlay();alert("同期に失敗しました："+(e?.message||String(e)));return false;}};
App.initIndex=function(){const s=document.getElementById("btnSync");if(s)s.addEventListener("click",App.doSync);const r=document.getElementById("btnRecalc");if(r)r.addEventListener("click",App.updateIndexCounts);App.updateIndexCounts();};
App.renderArea=function(city){const cont=document.getElementById("list");if(!cont)return;const items=App.getData(city);const st=App.getState(city);cont.innerHTML="";for(let i=0;i<items.length;i++){const it=items[i]||{station:"",model:"",plate:""};const row=document.createElement("div");row.className="row";if(st.flags[i]==="stopped")row.classList.add("stopped");else if(st.flags[i]==="skip")row.classList.add("skip");else if(st.checked[i])row.classList.add("checked");const idx=document.createElement("div");idx.className="idx";idx.textContent=(i+1);const btn=document.createElement("button");btn.className="chkbtn";btn.textContent=st.checked[i]?"✔":"□";btn.onclick=()=>{if(!confirm("よろしいですか？"))return;st.checked[i]=!st.checked[i];App.setState(city,st);App.renderArea(city);};const wrap=document.createElement("div");const t=document.createElement("div");t.className="title";t.textContent=it.station||"";const s=document.createElement("div");s.className="sub";s.textContent=(it.model||"")+"　"+(it.plate||"");wrap.appendChild(t);wrap.appendChild(s);const menu=document.createElement("div");menu.className="menu";const m=document.createElement("button");m.className="menubtn";m.textContent="…";m.onclick=()=>{const v=prompt("状態：\n0=通常（薄緑）\n1=稼働停止（グレー）\n2=巡回不要（黄色）","0");if(v===null)return;if(v==="1")st.flags[i]="stopped";else if(v==="2")st.flags[i]="skip";else st.flags[i]="";App.setState(city,st);App.renderArea(city);};menu.appendChild(m);row.appendChild(idx);const chk=document.createElement("div");chk.appendChild(btn);row.appendChild(chk);row.appendChild(wrap);row.appendChild(menu);cont.appendChild(row);}const k=App.computeCounters(city);const c=document.getElementById("count");if(c)c.textContent=`済${k.done}/停止${k.stopped}/不要${k.skip}/総${k.total}`;};
