<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>大和市 巡回</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="appbar">
    <a href="index.html" class="backlink">← 戻る</a>
    <div class="title">大和市 巡回</div>
    <span id="counter" class="counter"></span>
  </header>
  <div class="wrap">
    <section id="list" class="list"></section>
    <p id="empty" class="empty">まだ同期されていません</p>
  </div>
  <script>

    (function(){
      const CITY = document.title.replace(' 巡回','');
      const LS_KEY = 'junkai:items:v2';
      const STATE_LABEL = { normal:'通常', stopped:'稼働停止', skip:'巡回不要' };
      const STATE_NEXT = { normal:'stopped', stopped:'skip', skip:'normal' };

      const $ = (sel, root=document)=>root.querySelector(sel);

      function load(){
        try { const s = localStorage.getItem(LS_KEY); return s? JSON.parse(s): []; } catch(e){ return []; }
      }
      function save(items){
        localStorage.setItem(LS_KEY, JSON.stringify(items));
        window.dispatchEvent(new StorageEvent('storage', {key: LS_KEY}));
      }
      // 既存statusから新フィールドへ移行
      function migrate(items){
        let changed=false;
        items.forEach(it=>{
          if (it.city==null) return;
          if (it.done===undefined || it.state===undefined){
            const st = it.status||'';
            it.done = (st==='済') ? 1 : 0;
            it.state = (st==='停') ? 'stopped' : (st==='不要' ? 'skip' : 'normal');
            changed=true;
          }
          // 将来互換: statusはミラーリング
          it.status = it.done ? '済' : (it.state==='stopped' ? '停' : (it.state==='skip' ? '不要' : ''));
        });
        if (changed) save(items);
        return items;
      }

      function text(el, s){ el.textContent = s; }

      function applyClass(el, it){
        el.classList.remove('is-stopped','is-skip','is-done');
        if (it.state==='stopped') el.classList.add('is-stopped');
        else if (it.state==='skip') el.classList.add('is-skip');
        if (it.done) el.classList.add('is-done');
      }

      function render(){
        const items = migrate(load()).filter(it=>it.city===CITY);
        const listEl = $('#list'); listEl.innerHTML='';
        if (!items.length){ const d=document.createElement('div'); d.className='empty'; d.textContent='リストなし'; listEl.appendChild(d); updateCounter(0,0); return; }

        let done=0; const total=items.length;
        items.forEach(it=>{ if (it.done) done++; });

        items.forEach(it=>{
          const itemEl = document.createElement('div');
          itemEl.className = 'item';

          const left = document.createElement('div');
          left.className = 'meta';
          const row1 = document.createElement('div'); row1.className='row1';
          const station = document.createElement('span'); station.className='kv'; station.innerHTML = `<b>ステーション</b>${it.station||'-'}`;
          const model = document.createElement('span'); model.className='kv'; model.innerHTML = `<b>車種</b>${it.model||'-'}`;
          row1.appendChild(station); row1.appendChild(model);
          const row2 = document.createElement('div'); row2.className='row2';
          const plate = document.createElement('span'); plate.className='kv'; plate.innerHTML = `<b>登録番号</b>${it.plate||'-'}`;
          row2.appendChild(plate);
          left.appendChild(row1); left.appendChild(row2);

          const ctrl = document.createElement('div'); ctrl.className='ctrl';
          const doneChk = document.createElement('input'); doneChk.type='checkbox'; doneChk.className='donechk'; doneChk.checked=!!it.done;
          const stateBtn = document.createElement('button'); stateBtn.className='statebtn'; text(stateBtn, STATE_LABEL[it.state||'normal']);

          ctrl.appendChild(doneChk); ctrl.appendChild(stateBtn);

          itemEl.appendChild(left); itemEl.appendChild(ctrl);
          applyClass(itemEl, it);

          doneChk.addEventListener('change', ()=>{
            const all = load(); const t = all.find(a=>a.id===it.id);
            if (t){ t.done = doneChk.checked ? 1 : 0; t.status = t.done ? '済' : (t.state==='stopped'?'停': (t.state==='skip'?'不要':'')); save(all); }
            applyClass(itemEl, t||it);
            // 再計算してヘッダ更新
            const itemsNow = load().filter(x=>x.city===CITY); let d=0; itemsNow.forEach(x=>{ if (x.done) d++; }); updateCounter(d, itemsNow.length);
          });
          stateBtn.addEventListener('click', ()=>{
            const all = load(); const t = all.find(a=>a.id===it.id);
            if (t){
              t.state = STATE_NEXT[t.state||'normal'];
              t.status = t.done ? '済' : (t.state==='stopped'?'停': (t.state==='skip'?'不要':''));
              save(all);
              text(stateBtn, STATE_LABEL[t.state]);
              applyClass(itemEl, t);
            }
          });

          listEl.appendChild(itemEl);
        });

        updateCounter(done, total);
      }

      function updateCounter(done,total){
        const el = document.getElementById('counter');
        const pct = total? Math.floor(done*100/total): 0;
        el.textContent = `${done}/${total} (${pct}%)`;
      }

      document.addEventListener('DOMContentLoaded', render);
      window.addEventListener('storage', render);
    })();

</script>
</body>
</html>