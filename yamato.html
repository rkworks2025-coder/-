<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>大和市 巡回</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="appbar">
    <a href="index.html" class="backlink">← 戻る</a>
    <div class="title">大和市 巡回</div>
    <span id="counter" class="counter"></span>
  </header>
  <div class="wrap">
    <section id="list" class="list"></section>
    <p id="empty" class="empty">まだ同期されていません</p>
  </div>
  
  
  <script>
    (function(){ 
      const CITY_CANON = '大和市'; // 例: 大和市, 海老名市, 調布市
      const $ = (s,r=document)=>r.querySelector(s);
      const KEYS = ['junkai:items','junkai:items:v2']; // indexは 'junkai:items' を使用

      function load(){ 
        for (const k of KEYS){
          try{ const s=localStorage.getItem(k); if(s){ const a=JSON.parse(s); if(Array.isArray(a)) return a; } }catch(_){}
        }
        return [];
      }
      function canonCity(s){
        if(!s) return '';
        return String(s).replace(/巡回/g,'').replace(/\s+/g,'').trim();
      }
      function migrate(items){
        let changed=false;
        items.forEach(it=>{
          if (typeof it.done==='undefined' || typeof it.state==='undefined') {
            const st = it.status||'';
            it.done = (st==='済') ? 1 : 0;
            it.state = (st==='停') ? 'stopped' : (st==='不要' ? 'skip' : 'normal');
            changed=true;
          }
          it.status = it.done ? '済' : (it.state==='stopped' ? '停' : (it.state==='skip' ? '不要' : ''));
        });
        if (changed){ try{ localStorage.setItem('junkai:items', JSON.stringify(items)); }catch(__){} }
        return items;
      }
      function fmt(ts){ if(!ts) return ''; const d=new Date(ts); const M=String(d.getMonth()+1).padStart(2,'0'); const D=String(d.getDate()).padStart(2,'0'); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${M}/${D} ${h}:${m}`; }
      function updateCounter(done,total){ const el=$('#counter'); const pct= total? Math.floor(done*100/total):0; if(el) el.textContent = `${done}/${total} (${pct}%)`; }
      function applyClass(el, it){ el.classList.remove('stop','skip','done'); if(it.state==='stopped') el.classList.add('stop'); else if(it.state==='skip') el.classList.add('skip'); if(it.done) el.classList.add('done'); }

      function render(){ 
        const all = migrate(load());
        const listEl = $('#list'); const emptyEl = $('#empty');
        const canon = canonCity(CITY_CANON);
        const cityItems = all.filter(it=>{
          const c = canonCity(it.city);
          return c===canon || (c && canon && c.indexOf(canon) !== -1);
        });
        if (emptyEl) emptyEl.textContent = cityItems.length? '' : 'まだ同期されていません';
        listEl.innerHTML='';
        if (!cityItems.length) { updateCounter(0,0); return; }
        let done=0; const total = cityItems.length;
        cityItems.forEach(it=>{ if(it.done) done++; });
        updateCounter(done,total);

        cityItems.forEach((it, idx)=>{
          const itemEl = document.createElement('div'); itemEl.className='item';
          applyClass(itemEl, it);
          const row1=document.createElement('div'); row1.className='row1';
          const left=document.createElement('div'); left.className='left';
          const idxSpan=document.createElement('span'); idxSpan.className='idx'; idxSpan.textContent=String(idx+1);
          const doneBox=document.createElement('input'); doneBox.type='checkbox'; doneBox.className='checkbox'; doneBox.checked=!!it.done;
          doneBox.addEventListener('change',(ev)=>{ if(!confirm('よろしいですか？')){ ev.target.checked=!ev.target.checked; return; } it.done=ev.target.checked?1:0; it.updatedAt = ev.target.checked ? Date.now() : null;
            try{ const a=migrate(load()); const t=a.find(x=>x.city===it.city && x.station===it.station && x.model===it.model && x.plate===it.plate); if(t){ t.done=it.done; t.updatedAt = it.updatedAt; localStorage.setItem('junkai:items', JSON.stringify(a)); } }catch(__){} dateSpan.textContent = ev.target.checked ? fmt(it.updatedAt) : ''; render();
          });
          const stationSpan=document.createElement('span'); stationSpan.textContent = it.station||'';
          left.appendChild(idxSpan); left.appendChild(doneBox); left.appendChild(stationSpan);
          row1.appendChild(left);
          const right=document.createElement('div');
          const dateSpan=document.createElement('span'); dateSpan.className='date'; dateSpan.textContent = it.done ? fmt(it.updatedAt) : '';
          const stateBtn=document.createElement('button'); stateBtn.className='checkbox'; stateBtn.textContent = it.state==='stopped'?'停':(it.state==='skip'?'不要':'状態');
          stateBtn.addEventListener('click',()=>{ const input = prompt('状態を選択：\n0=通常\n1=稼働停止（グレー）\n2=巡回不要（黄色）', it.state==='stopped'?'1':(it.state==='skip'?'2':'0')); if(input===null) return; const code=String(input).trim(); const map={'0':'normal','1':'stopped','2':'skip'}; if(!(code in map)) return; it.state=map[code]; it.updatedAt=Date.now();
            try{ const a=migrate(load()); const t=a.find(x=>x.city===it.city && x.station===it.station && x.model===it.model && x.plate===it.plate); if(t){ t.state=it.state; t.updatedAt=it.updatedAt; localStorage.setItem('junkai:items', JSON.stringify(a)); } }catch(__){} render();
          });
          right.appendChild(dateSpan); right.appendChild(stateBtn);
          row1.appendChild(right);
          itemEl.appendChild(row1);
          const row2=document.createElement('div'); row2.className='row2';
          const modelSpan=document.createElement('span'); modelSpan.className='kv'; modelSpan.innerHTML = `${it.model||''}`;
          const plateSpan=document.createElement('span'); plateSpan.className='kv'; plateSpan.innerHTML = `${it.plate||''}`;
          row2.appendChild(modelSpan); row2.appendChild(plateSpan);
          itemEl.appendChild(row2);
          listEl.appendChild(itemEl);
        });
      }
      document.addEventListener('DOMContentLoaded', render);
      window.addEventListener('storage', render);
    })();
  </script>


</body>
</html>