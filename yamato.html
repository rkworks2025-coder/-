<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>大和市 巡回</title>

<style>
  :root{
    --bg:#f6f7fb; --surface:#fff; --border:#e6e8ee; --text:#111; --muted:#6b7280; --accent:#111; --checked:#ffe8ef;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--surface);padding:12px 16px;border-bottom:1px solid var(--border);z-index:10;display:flex;gap:8px;align-items:center}
  header .back{text-decoration:none;border:1px solid var(--border);padding:8px 12px;border-radius:12px;color:var(--text)}
  header h1{margin:0;font-size:18px;flex:1;text-align:center}
  header .count{font-weight:700;color:var(--muted);font-variant-numeric:tabular-nums}
  main{padding:12px 12px 24px;max-width:820px;margin:0 auto}
  .toolbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;justify-content:center}
  .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--surface);text-decoration:none;color:var(--text);cursor:pointer}
  .danger{color:#b42318;border-color:#f2c6c4;background:#fff5f4}
  .card{display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:10px;box-shadow:0 1px 2px rgba(0,0,0,.04);transition:background .15s,border-color .15s}
  .card.checked{background:var(--checked);border-color:#f8c9d7}
  .chk-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;flex:none}
  .chk{appearance:none;width:0;height:0;position:absolute;opacity:0}
  .fake{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-radius:6px;background:#fff}
  .chk:checked + .fake{border-color:var(--accent);background:var(--accent);background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path fill="white" d="M6.6 11.6L3.5 8.5l1.1-1.1 2 2 4-4 1.1 1.1z"/></svg>');background-repeat:no-repeat;background-position:center}
  .body{flex:1;min-width:0}
  .title{font-weight:700;white-space:normal;word-break:break-word;line-height:1.35;margin-bottom:2px}
  .meta{margin-top:4px;color:var(--muted);font-size:14px;line-height:1.5}
  .meta .line{white-space:normal;word-break:break-word}
  .meta .line.small{font-size:12px}
  .date-badge{min-width:54px;text-align:center;font-variant-numeric:tabular-nums;color:var(--muted);font-weight:700}
  .ver{position:fixed;right:8px;bottom:6px;font-size:10px;color:#94a3b8;opacity:.7;pointer-events:none;z-index:9}
</style>

<header>
  <a class="back" href="index.html">戻る</a>
  <h1>大和市 巡回</h1>
  <span class="count" id="count">0/0</span>
</header>
<main>
  <!-- 上部の一括操作ボタンは不要のため削除しました -->
  <div id="list"></div>
</main>

<script>
const CITY = '大和市';
const GAS_URL = 'https://script.google.com/macros/s/AKfycby9RpFiUbYu6YX6JW9XfwbDx36_4AIlGEQMOxR3SnxgNdoRUJKfyxvF3b1SEYwuHb3X/exec';

async function fetchRecords(){
  try{
    const res = await fetch(GAS_URL + '?action=pull');
    const json = await res.json();
    let records=[];
    if(Array.isArray(json.data) && json.data.length){
      const first = json.data[0];
      if(Array.isArray(first)){
        const headers = first;
        for(let i=1;i<json.data.length;i++){
          const row = json.data[i];
          let obj = {};
          headers.forEach((h, idx) => { obj[h] = row[idx]; });
          records.push(obj);
        }
      } else {
        records = json.data;
      }
    }
    return records;
  } catch(e){
    console.error(e);
    return [];
  }
}

function storageKey(key){ return 'chk:'+CITY+':'+key; }
function saveChecked(key,val){ localStorage.setItem(storageKey(key), JSON.stringify({checked:val, timestamp:(new Date()).toISOString()})); }
function loadChecked(key){ try{ const v=JSON.parse(localStorage.getItem(storageKey(key))); return v&&v.checked; }catch(e){ return false; } }

function updateCount(total){
  const checked = document.querySelectorAll('#list input.chk:checked').length;
  document.getElementById('count').textContent = checked + '/' + total;
}

function buildCard(rec){
  const station = rec['station'] || rec['ステーション'] || rec['stationName'] || rec['Station'] || '';
  const model   = rec['model']   || rec['車種名']     || rec['Model']        || '';
  const plate   = rec['plate']   || rec['登録番号']   || rec['number']        || rec['plate_full'] || rec['Plate'] || '';
  const key = plate || station + '-' + model;
  const checked = loadChecked(key);
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.key = key;
  if(checked) card.classList.add('checked');
  card.innerHTML = `
    <label class="chk-wrap">
      <input type="checkbox" class="chk"${checked?' checked':''}>
      <span class="fake"></span>
    </label>
    <div class="body">
      <div class="title">${station || '(ステーション不明)'}</div>
      <div class="meta"><div class="line">${model || ''}</div><div class="line">${plate || ''}</div></div>
      <div class="actions"><a href="https://rkworks2025-coder.github.io/r.k.w-/?station=${encodeURIComponent(station)}&model=${encodeURIComponent(model)}&plate_full=${encodeURIComponent(plate)}" target="_blank" class="inspect-link">点検</a></div>
    </div>
    <div class="date-badge"></div>
  `;
  const checkbox = card.querySelector('input.chk');
  checkbox.addEventListener('change', () => {
    const isChecked = checkbox.checked;
    card.classList.toggle('checked', isChecked);
    saveChecked(key, isChecked);
    updateCount(window.totalItems || 0);
    // TODO: send log to GAS (inspectionlog)
  });
  return card;
}

async function loadList(){
  const data = await fetchRecords();
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  const filtered = data.filter(rec => {
    const city = rec['city'] || rec['市区町村'] || rec['City'];
    return city === CITY;
  });
  window.totalItems = filtered.length;
  filtered.forEach(rec => {
    const card = buildCard(rec);
    listEl.appendChild(card);
  });
  updateCount(filtered.length);
}

function checkAll(){ document.querySelectorAll('#list .chk').forEach(chk => { if(!chk.checked){ chk.checked = true; chk.dispatchEvent(new Event('change')); } }); }
function uncheckAll(){ document.querySelectorAll('#list .chk').forEach(chk => { if(chk.checked){ chk.checked = false; chk.dispatchEvent(new Event('change')); } }); }
function resetAll(){ if(confirm('チェック状態をリセットしますか？')){
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith('chk:'+CITY+':')){
        localStorage.removeItem(k);
      }
    }
    loadList();
  }
}

document.addEventListener('DOMContentLoaded', loadList);
</script>

<div class="ver">v4</div>
</html>